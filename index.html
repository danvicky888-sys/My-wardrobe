<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI 智慧衣櫥 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --safe-bottom: env(safe-area-inset-bottom); }
        body { -webkit-tap-highlight-color: transparent; padding-bottom: calc(80px + var(--safe-bottom)); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .active-nav { color: #4f46e5; border-top: 3px solid #4f46e5; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .filter-active { background: #4f46e5 !important; color: white !important; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b px-6 pt-12 pb-4 flex justify-between items-end">
        <div>
            <h1 class="text-2xl font-black text-indigo-600 tracking-tighter">AI CLOSET</h1>
            <div id="weatherDisplay" class="text-[11px] font-bold text-slate-400 mt-1 flex items-center gap-1">
                <i class="fas fa-spinner fa-spin"></i> 偵測天氣中...
            </div>
        </div>
        <div class="flex gap-4 pb-1 text-slate-400">
            <button onclick="exportData()"><i class="fas fa-file-export"></i></button>
            <button onclick="document.getElementById('importFile').click()"><i class="fas fa-file-import"></i></button>
            <input type="file" id="importFile" class="hidden" onchange="importData(event)">
        </div>
    </header>

    <main class="p-4">
        <section id="wardrobeSection" class="tab-content active">
            <div class="flex gap-2 overflow-x-auto no-scrollbar mb-4 pb-2" id="catBar"></div>
            <div id="grid" class="grid grid-cols-2 gap-4"></div>
            <div id="empty" class="hidden py-20 text-center text-slate-300 flex flex-col items-center">
                <i class="fas fa-tshirt text-5xl mb-4 opacity-20"></i>
                <p>你的衣櫥目前是空的</p>
            </div>
        </section>

        <section id="outfitSection" class="tab-content">
            <div class="bg-indigo-600 rounded-[32px] p-6 text-white mb-6 shadow-xl relative overflow-hidden">
                <div class="relative z-10">
                    <h3 class="font-bold text-lg mb-1">智慧提案助手</h3>
                    <p id="weatherAdvice" class="text-xs opacity-80 mb-5">正在分析天氣適合的穿著...</p>
                    
                    <div class="space-y-3">
                        <div class="relative">
                            <i class="fas fa-palette absolute left-4 top-3.5 text-white/50"></i>
                            <input type="text" id="moodInput" placeholder="輸入顏色或心情 (如：藍色、心情好)" class="w-full bg-white/20 border border-white/20 rounded-2xl py-3 pl-11 pr-4 text-sm placeholder:text-white/40 outline-none focus:bg-white/30 transition">
                        </div>
                        <button onclick="generateAI()" class="w-full bg-white text-indigo-600 font-black py-4 rounded-2xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                            <i class="fas fa-wand-magic-sparkles"></i> 產生今日穿搭
                        </button>
                    </div>
                </div>
                <i class="fas fa-cloud-sun-rain absolute -right-6 -top-6 text-9xl opacity-10"></i>
            </div>
            <div id="aiResult" class="grid grid-cols-1 gap-4"></div>
        </section>

        <section id="statsSection" class="tab-content">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">總資產</p>
                    <p id="statPrice" class="text-xl font-black text-indigo-600">$0</p>
                </div>
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">總件數</p>
                    <p id="statCount" class="text-xl font-black text-indigo-600">0 Items</p>
                </div>
            </div>
            <h3 class="font-bold mb-4 flex items-center gap-2"><i class="fas fa-leaf text-green-500"></i> 斷捨離建議</h3>
            <div id="cleanup" class="space-y-3"></div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-xl border-t flex justify-around items-center safe-bottom h-20 z-50 px-4">
        <button onclick="switchTab('wardrobe')" class="nav-btn active-nav flex flex-col items-center gap-1 transition-all"><i class="fas fa-th-large text-lg"></i><span class="text-[9px] font-bold">衣櫥</span></button>
        <button onclick="switchTab('outfit')" class="nav-btn flex flex-col items-center gap-1 transition-all"><i class="fas fa-sparkles text-lg"></i><span class="text-[9px] font-bold">AI 提案</span></button>
        <button onclick="openAdd()" class="bg-indigo-600 text-white w-14 h-14 rounded-full -mt-10 shadow-2xl flex items-center justify-center text-xl border-[6px] border-slate-50 active:scale-90 transition-transform"><i class="fas fa-plus"></i></button>
        <button onclick="switchTab('stats')" class="nav-btn flex flex-col items-center gap-1 transition-all"><i class="fas fa-chart-line text-lg"></i><span class="text-[9px] font-bold">分析</span></button>
        <button onclick="location.reload()" class="nav-btn flex flex-col items-center gap-1 transition-all"><i class="fas fa-sync-alt text-lg"></i><span class="text-[9px] font-bold">重新整理</span></button>
    </nav>

    <div id="addModal" class="fixed inset-0 bg-black/70 z-[60] hidden flex items-end">
        <div class="bg-white w-full rounded-t-[40px] p-8 animate-slide-up max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-xl font-black">多圖批次上傳</h2>
                <button onclick="closeAdd()" class="text-slate-300 text-3xl">&times;</button>
            </div>
            
            <div class="bg-slate-50 border-2 border-dashed border-slate-200 rounded-[32px] p-10 text-center mb-8 relative hover:bg-slate-100 transition">
                <i class="fas fa-cloud-upload-alt text-4xl text-indigo-400 mb-3"></i>
                <p class="text-sm font-bold text-slate-500">點擊或拖放多張衣服照片</p>
                <input type="file" id="batchInput" accept="image/*" multiple class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleFiles(this)">
            </div>

            <div id="previewList" class="grid grid-cols-2 gap-4 mb-8"></div>

            <button onclick="saveBatch()" id="saveBtn" class="hidden w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-xl active:scale-95 transition">確認匯入 (<span id="count">0</span> 件單品)</button>
        </div>
    </div>

    <script>
        let state = JSON.parse(localStorage.getItem('ai_wardrobe_final')) || { items: [], cats: ["上衣", "下著", "外套", "鞋子", "配件"] };
        let currentTab = 'wardrobe';
        let currentFilter = '全部';
        let tempItems = [];
        let weather = { temp: 22 };

        // --- 初始化 ---
        window.onload = () => {
            detectWeather();
            render();
        };

        // --- 天氣偵測 ---
        async function detectWeather() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`);
                        const data = await res.json();
                        weather.temp = data.current_weather.temperature;
                        document.getElementById('weatherDisplay').innerHTML = `<i class="fas fa-temperature-low"></i> 當前氣溫 ${weather.temp}°C`;
                        updateAdvice();
                    } catch (e) { document.getElementById('weatherDisplay').innerText = "天氣讀取失敗"; }
                }, () => { document.getElementById('weatherDisplay').innerText = "請開啟定位權限以獲取天氣"; });
            }
        }

        function updateAdvice() {
            const el = document.getElementById('weatherAdvice');
            if(weather.temp < 15) el.innerText = `氣溫 ${weather.temp}°C 偏寒冷，AI 建議穿著厚外套或保暖毛衣。`;
            else if(weather.temp < 22) el.innerText = `氣溫 ${weather.temp}°C 涼爽，建議穿搭薄外套或長袖單品。`;
            else el.innerText = `氣溫 ${weather.temp}°C 炎熱，建議選擇短袖、透氣材質。`;
        }

        // --- 多圖上傳處理 ---
        function handleFiles(input) {
            const files = Array.from(input.files);
            tempItems = [];
            const list = document.getElementById('previewList');
            list.innerHTML = "";
            
            files.forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = e => {
                    const item = { id: Date.now()+idx, img: e.target.result, name: `單品 ${state.items.length + idx + 1}`, cat: "上衣", price: 0, date: new Date().toISOString().split('T')[0] };
                    tempItems.push(item);
                    list.innerHTML += `
                        <div class="bg-white p-3 rounded-3xl border border-slate-100 shadow-sm animate-pop">
                            <img src="${item.img}" class="w-full aspect-square object-cover rounded-2xl mb-3">
                            <select onchange="tempItems[${idx}].cat = this.value" class="w-full text-[10px] font-bold p-2 bg-slate-50 rounded-xl outline-none">
                                ${state.cats.map(c => `<option value="${c}">${c}</option>`).join('')}
                            </select>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            });
            document.getElementById('saveBtn').classList.remove('hidden');
            document.getElementById('count').innerText = files.length;
        }

        function saveBatch() {
            state.items = [...state.items, ...tempItems];
            save();
            closeAdd();
            render();
        }

        // --- AI 建議引擎 ---
        function generateAI() {
            const mood = document.getElementById('moodInput').value.toLowerCase();
            const result = document.getElementById('aiResult');
            
            // 基礎池過濾：根據天氣與心情
            let pool = state.items;
            if(weather.temp < 18) pool = pool.filter(i => i.cat === "外套" || i.price > 500); // 簡單模擬保暖
            if(mood) pool = pool.filter(i => i.name.toLowerCase().includes(mood) || i.cat.includes(mood));

            const tops = pool.filter(i => i.cat === "上衣");
            const bottoms = pool.filter(i => i.cat === "下著");
            const shoes = pool.filter(i => i.cat === "鞋子");

            if(tops.length && bottoms.length) {
                const t = tops[Math.floor(Math.random()*tops.length)];
                const b = bottoms[Math.floor(Math.random()*bottoms.length)];
                const s = shoes[Math.floor(Math.random()*shoes.length)];

                result.innerHTML = `
                    <div class="bg-white p-6 rounded-[40px] shadow-sm animate-pop border border-slate-100">
                        <div class="flex justify-between items-center mb-6">
                            <p class="text-[10px] font-black text-indigo-500 tracking-widest uppercase">今日推薦組合</p>
                            <span class="bg-indigo-50 text-indigo-600 text-[10px] px-3 py-1 rounded-full font-bold">${mood || '舒適'}風格</span>
                        </div>
                        <div class="flex gap-3 h-48">
                            <img src="${t.img}" class="flex-1 object-cover rounded-[24px]">
                            <img src="${b.img}" class="flex-1 object-cover rounded-[24px]">
                            ${s ? `<img src="${s.img}" class="flex-1 object-cover rounded-[24px]">` : ''}
                        </div>
                        <div class="mt-6 flex justify-between items-center">
                            <div>
                                <p class="text-xs font-bold text-slate-800">${t.name} + ${b.name}</p>
                                <p class="text-[10px] text-slate-400">符合當前氣溫 ${weather.temp}°C</p>
                            </div>
                            <button onclick="generateAI()" class="w-10 h-10 bg-slate-50 text-slate-400 rounded-full hover:bg-indigo-50 hover:text-indigo-600 transition"><i class="fas fa-redo"></i></button>
                        </div>
                    </div>
                `;
            } else {
                result.innerHTML = `<p class="text-center py-20 text-slate-300 text-sm">找不到符合條件的組合，請多新增一些衣服吧！</p>`;
            }
        }

        // --- 核心渲染與邏輯 ---
        function render() {
            renderCatBar();
            renderGrid();
            renderStats();
            save();
        }

        function renderCatBar() {
            const bar = document.getElementById('catBar');
            const counts = {};
            state.items.forEach(i => counts[i.cat] = (counts[i.cat] || 0) + 1);
            
            bar.innerHTML = ["全部", ...state.cats].map(c => {
                const n = c === "全部" ? state.items.length : (counts[c] || 0);
                return `<button onclick="setFilter('${c}')" class="${currentFilter===c?'filter-active':''} bg-white px-5 py-2.5 rounded-2xl text-[11px] font-black shadow-sm whitespace-nowrap transition">${c} <span class="opacity-40 ml-1">${n}</span></button>`;
            }).join('');
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            const filtered = state.items.filter(i => currentFilter === "全部" || i.cat === currentFilter);
            document.getElementById('empty').classList.toggle('hidden', filtered.length > 0);
            grid.innerHTML = filtered.map(i => `
                <div ondblclick="removeItem(${i.id})" class="bg-white rounded-[32px] overflow-hidden shadow-sm border border-slate-100 animate-pop">
                    <div class="aspect-[4/5] bg-slate-50 relative">
                        <img src="${i.img}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-4">
                        <p class="text-[9px] font-black text-indigo-500 uppercase tracking-wider mb-0.5">${i.cat}</p>
                        <p class="text-xs font-bold truncate text-slate-800">${i.name}</p>
                    </div>
                </div>
            `).join('');
        }

        function renderStats() {
            const total = state.items.reduce((s, i) => s + (Number(i.price)||0), 0);
            document.getElementById('statPrice').innerText = `$${total.toLocaleString()}`;
            document.getElementById('statCount').innerText = `${state.items.length} Items`;
            
            const sixMo = new Date(); sixMo.setMonth(sixMo.getMonth() - 6);
            const old = state.items.filter(i => new Date(i.date) < sixMo);
            document.getElementById('cleanup').innerHTML = old.map(i => `
                <div class="flex items-center gap-4 bg-white p-4 rounded-3xl border border-slate-50 shadow-sm">
                    <img src="${i.img}" class="w-12 h-12 rounded-2xl object-cover">
                    <div class="flex-1">
                        <p class="text-xs font-bold">${i.name}</p>
                        <p class="text-[10px] text-red-400">超過半年沒穿</p>
                    </div>
                    <button onclick="removeItem(${i.id})" class="text-slate-300 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button>
                </div>
            `).join('');
        }

        function setFilter(f) { currentFilter = f; render(); }
        function switchTab(t) {
            currentTab = t;
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-nav'));
            document.getElementById(t + 'Section').classList.add('active');
            if(t === 'outfit') generateAI();
            render();
        }
        function removeItem(id) { if(confirm('要移除這件衣服嗎？')) { state.items = state.items.filter(i => i.id !== id); render(); } }
        function openAdd() { document.getElementById('addModal').classList.remove('hidden'); }
        function closeAdd() { document.getElementById('addModal').classList.add('hidden'); }
        function save() { localStorage.setItem('ai_wardrobe_final', JSON.stringify(state)); }
        function exportData() {
            const blob = new Blob([JSON.stringify(state)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'wardrobe.json'; a.click();
        }
        function importData(e) {
            const reader = new FileReader();
            reader.onload = ev => { state = JSON.parse(ev.target.result); render(); alert('資料匯入完成！'); };
            reader.readAsText(e.target.files[0]);
        }
    </script>
</body>
</html>
