<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>我的衣櫥 Pro (本地版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --safe-bottom: env(safe-area-inset-bottom); }
        body { -webkit-tap-highlight-color: transparent; padding-bottom: calc(80px + var(--safe-bottom)); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .active-nav { color: #4f46e5; border-top: 3px solid #4f46e5; }
        .active-filter { background-color: #4f46e5 !important; color: white !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b px-6 pt-10 pb-4 flex justify-between items-center">
        <h1 id="pageTitle" class="text-xl font-black text-indigo-600 uppercase">My Wardrobe</h1>
        <div class="flex gap-3 text-slate-400">
            <button onclick="exportData()"><i class="fas fa-file-export"></i></button>
            <button onclick="document.getElementById('importFile').click()"><i class="fas fa-file-import"></i></button>
            <input type="file" id="importFile" class="hidden" onchange="importData(event)">
        </div>
    </header>

    <main class="p-4">
        <section id="wardrobeSection" class="tab-content active">
            <div class="flex gap-2 overflow-x-auto no-scrollbar mb-6 pb-2" id="catFilterBar"></div>
            <div id="itemGrid" class="grid grid-cols-2 gap-4"></div>
            <div id="emptyMsg" class="hidden text-center py-20 text-slate-300">目前沒有單品</div>
        </section>

        <section id="outfitSection" class="tab-content">
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-6 rounded-3xl text-white mb-6 shadow-lg">
                <h3 class="font-bold text-lg">今日穿搭提案</h3>
                <p class="text-xs opacity-80">根據你的衣櫥隨機組合</p>
                <button onclick="generateSuggestion()" class="mt-4 bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl text-sm backdrop-blur-md transition">
                    <i class="fas fa-redo-alt mr-2"></i>換一組試試
                </button>
            </div>
            <div id="suggestionBox" class="grid grid-cols-3 gap-2 mb-6">
                </div>
            <div id="suggestionMsg" class="text-center text-slate-400 text-sm hidden">請先新增上衣、下著和鞋子才能生成建議</div>
        </section>

        <section id="statsSection" class="tab-content">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-2xl shadow-sm">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">總價值</p>
                    <p id="totalPrice" class="text-xl font-black text-indigo-600">$0</p>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">總件數</p>
                    <p id="totalCount" class="text-xl font-black text-indigo-600">0 件</p>
                </div>
            </div>
            <h3 class="font-bold mb-4 flex items-center"><i class="fas fa-recycle mr-2 text-green-500"></i>斷捨離清單</h3>
            <div id="cleanupList" class="space-y-3"></div>
        </section>

        <section id="settingsSection" class="tab-content">
            <div class="bg-white rounded-2xl p-4 shadow-sm">
                <h3 class="font-bold mb-4">分類管理</h3>
                <div id="manageCats" class="flex flex-wrap gap-2 mb-4"></div>
                <div class="flex gap-2">
                    <input type="text" id="newCatInput" placeholder="自訂分類 (如：運動)" class="flex-1 bg-slate-100 p-3 rounded-xl text-sm outline-none">
                    <button onclick="addCategory()" class="bg-indigo-600 text-white px-6 rounded-xl font-bold">新增</button>
                </div>
            </div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around items-center safe-bottom h-16 z-50">
        <button onclick="switchTab('wardrobe')" class="nav-btn active-nav flex flex-col items-center flex-1 py-2"><i class="fas fa-th-large"></i><span class="text-[10px]">衣櫥</span></button>
        <button onclick="switchTab('outfit')" class="nav-btn flex flex-col items-center flex-1 py-2"><i class="fas fa-wand-magic-sparkles"></i><span class="text-[10px]">提案</span></button>
        <button onclick="openAddModal()" class="bg-indigo-600 text-white w-12 h-12 rounded-full -mt-10 shadow-xl flex items-center justify-center text-xl border-4 border-slate-50"><i class="fas fa-plus"></i></button>
        <button onclick="switchTab('stats')" class="nav-btn flex flex-col items-center flex-1 py-2"><i class="fas fa-chart-line"></i><span class="text-[10px]">分析</span></button>
        <button onclick="switchTab('settings')" class="nav-btn flex flex-col items-center flex-1 py-2"><i class="fas fa-cog"></i><span class="text-[10px]">設定</span></button>
    </nav>

    <div id="itemModal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end">
        <div class="bg-white w-full rounded-t-[32px] p-6 animate-slide-up max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-xl font-bold">編輯單品</h2>
                <button onclick="closeModal()" class="text-slate-300 text-3xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div class="flex gap-4">
                    <div class="w-24 h-24 bg-slate-100 rounded-2xl relative overflow-hidden flex items-center justify-center border-2 border-dashed border-slate-200">
                        <i class="fas fa-camera text-slate-300 text-2xl"></i>
                        <input type="file" id="itemImg" accept="image/*" class="absolute inset-0 opacity-0" onchange="previewFile(this)">
                        <img id="modalPreview" class="absolute inset-0 w-full h-full object-cover hidden">
                    </div>
                    <div class="flex-1 space-y-2">
                        <input type="text" id="itemName" placeholder="單品名稱" class="w-full bg-slate-50 p-3 rounded-xl outline-none">
                        <select id="itemCat" class="w-full bg-slate-50 p-3 rounded-xl outline-none"></select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="itemPrice" placeholder="購買金額" class="bg-slate-50 p-3 rounded-xl outline-none">
                    <input type="date" id="itemDate" class="bg-slate-50 p-3 rounded-xl outline-none text-sm">
                </div>
                <div class="pt-4 flex gap-3">
                    <button id="deleteBtn" onclick="deleteItem()" class="bg-red-50 text-red-500 w-14 h-14 rounded-2xl hidden"><i class="fas fa-trash text-lg"></i></button>
                    <button onclick="saveItem()" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition">存入衣櫥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 資料狀態 ---
        let state = JSON.parse(localStorage.getItem('wardrobe_lite')) || {
            items: [],
            categories: ["上衣", "下著", "外套", "鞋子", "配件"]
        };
        let currentFilter = "全部";
        let editingId = null;

        // --- 初始化 ---
        function init() {
            render();
            generateSuggestion();
        }

        // --- 切換分頁 ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-nav'));
            document.getElementById(tab + 'Section').classList.add('active');
            event.currentTarget.classList.add('active-nav');
            if(tab === 'outfit') generateSuggestion();
            render();
        }

        // --- 核心渲染 ---
        function render() {
            renderFilterBar();
            renderGrid();
            renderStats();
            renderSettings();
            localStorage.setItem('wardrobe_lite', JSON.stringify(state));
        }

        // 1. 分類列 (含數量顯示)
        function renderFilterBar() {
            const bar = document.getElementById('catFilterBar');
            const counts = {};
            state.items.forEach(i => counts[i.cat] = (counts[i.cat] || 0) + 1);

            const filters = ["全部", ...state.categories];
            bar.innerHTML = filters.map(f => {
                const count = (f === "全部") ? state.items.length : (counts[f] || 0);
                const isActive = (currentFilter === f) ? 'active-filter' : 'bg-white';
                return `
                    <button onclick="setFilter('${f}')" class="${isActive} px-4 py-2 rounded-full text-xs font-bold shadow-sm whitespace-nowrap transition">
                        ${f} <span class="opacity-50 ml-1">${count}</span>
                    </button>
                `;
            }).join('');
        }

        // 2. 衣物網格 (支援分類點擊)
        function setFilter(f) {
            currentFilter = f;
            render();
        }

        function renderGrid() {
            const grid = document.getElementById('itemGrid');
            const filtered = state.items.filter(i => currentFilter === "全部" || i.cat === currentFilter);
            
            document.getElementById('emptyMsg').classList.toggle('hidden', filtered.length > 0);
            
            grid.innerHTML = filtered.map(i => `
                <div onclick="openEditModal(${i.id})" class="bg-white rounded-[24px] overflow-hidden shadow-sm border border-slate-100 scale-in transition active:scale-95">
                    <div class="aspect-[4/5] bg-slate-50">
                        <img src="${i.img || 'https://via.placeholder.com/200'}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-3">
                        <p class="text-[9px] font-black text-indigo-500 uppercase">${i.cat}</p>
                        <p class="font-bold text-sm truncate text-slate-700">${i.name}</p>
                        <p class="text-xs text-slate-400 mt-0.5">$${i.price || 0}</p>
                    </div>
                </div>
            `).join('');
        }

        // 3. 穿搭建議邏輯
        function generateSuggestion() {
            const box = document.getElementById('suggestionBox');
            const msg = document.getElementById('suggestionMsg');
            
            const tops = state.items.filter(i => i.cat === "上衣");
            const bottoms = state.items.filter(i => i.cat === "下著");
            const shoes = state.items.filter(i => i.cat === "鞋子");

            if(tops.length > 0 && bottoms.length > 0 && shoes.length > 0) {
                msg.classList.add('hidden');
                box.classList.remove('hidden');
                
                const randomT = tops[Math.floor(Math.random() * tops.length)];
                const randomB = bottoms[Math.floor(Math.random() * bottoms.length)];
                const randomS = shoes[Math.floor(Math.random() * shoes.length)];

                box.innerHTML = [randomT, randomB, randomS].map(i => `
                    <div class="bg-white p-2 rounded-2xl shadow-sm text-center">
                        <img src="${i.img}" class="w-full aspect-square object-cover rounded-xl mb-2">
                        <p class="text-[10px] font-bold truncate">${i.name}</p>
                    </div>
                `).join('');
            } else {
                box.classList.add('hidden');
                msg.classList.remove('hidden');
            }
        }

        // 4. 分析功能
        function renderStats() {
            const total = state.items.reduce((s, i) => s + (parseFloat(i.price) || 0), 0);
            document.getElementById('totalPrice').innerText = `$${total.toLocaleString()}`;
            document.getElementById('totalCount').innerText = `${state.items.length} 件`;

            const halfYearAgo = new Date();
            halfYearAgo.setMonth(halfYearAgo.getMonth() - 6);
            
            const oldItems = state.items.filter(i => i.date && new Date(i.date) < halfYearAgo);
            document.getElementById('cleanupList').innerHTML = oldItems.map(i => `
                <div class="flex items-center gap-3 bg-white p-3 rounded-2xl border border-red-50 shadow-sm">
                    <img src="${i.img}" class="w-10 h-10 rounded-lg object-cover">
                    <div class="flex-1">
                        <p class="text-sm font-bold">${i.name}</p>
                        <p class="text-[10px] text-red-400">超過半年沒穿</p>
                    </div>
                    <button onclick="openEditModal(${i.id})" class="text-xs font-bold text-indigo-500">查看</button>
                </div>
            `).join('');
        }

        // 5. 設定管理
        function renderSettings() {
            const list = document.getElementById('manageCats');
            list.innerHTML = state.categories.map(c => `
                <div class="bg-slate-100 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2">
                    ${c} <button onclick="removeCategory('${c}')" class="text-slate-400">&times;</button>
                </div>
            `).join('');
            
            const select = document.getElementById('itemCat');
            select.innerHTML = state.categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        // --- 操作功能 ---
        function openAddModal() {
            editingId = null;
            document.getElementById('modalTitle').innerText = "新增單品";
            document.getElementById('itemName').value = "";
            document.getElementById('itemPrice').value = "";
            document.getElementById('modalPreview').classList.add('hidden');
            document.getElementById('deleteBtn').classList.add('hidden');
            document.getElementById('itemModal').classList.remove('hidden');
        }

        function openEditModal(id) {
            editingId = id;
            const item = state.items.find(i => i.id === id);
            document.getElementById('modalTitle').innerText = "編輯單品";
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemDate').value = item.date;
            document.getElementById('itemCat').value = item.cat;
            document.getElementById('modalPreview').src = item.img;
            document.getElementById('modalPreview').classList.remove('hidden');
            document.getElementById('deleteBtn').classList.remove('hidden');
            document.getElementById('itemModal').classList.remove('hidden');
        }

        function saveItem() {
            const name = document.getElementById('itemName').value;
            const price = document.getElementById('itemPrice').value;
            const cat = document.getElementById('itemCat').value;
            const date = document.getElementById('itemDate').value;
            const img = document.getElementById('modalPreview').src;

            if(!name || !img) { alert('請輸入名稱並選擇圖片'); return; }

            const newItem = { id: editingId || Date.now(), name, price, cat, date, img };

            if(editingId) {
                const idx = state.items.findIndex(i => i.id === editingId);
                state.items[idx] = newItem;
            } else {
                state.items.push(newItem);
            }
            closeModal();
            render();
        }

        function deleteItem() {
            if(confirm('確定要刪除這件衣服嗎？')) {
                state.items = state.items.filter(i => i.id !== editingId);
                closeModal();
                render();
            }
        }

        function closeModal() { document.getElementById('itemModal').classList.add('hidden'); }

        function previewFile(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('modalPreview').src = e.target.result;
                    document.getElementById('modalPreview').classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addCategory() {
            const input = document.getElementById('newCatInput');
            if(input.value && !state.categories.includes(input.value)) {
                state.categories.push(input.value);
                input.value = "";
                render();
            }
        }

        function removeCategory(c) {
            state.categories = state.categories.filter(cat => cat !== c);
            render();
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(state)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'wardrobe_backup.json';
            a.click();
        }

        function importData(e) {
            const reader = new FileReader();
            reader.onload = event => {
                state = JSON.parse(event.target.result);
                render();
                alert('匯入成功！');
            };
            reader.readAsText(e.target.files[0]);
        }

        init();
    </script>
</body>
</html>
